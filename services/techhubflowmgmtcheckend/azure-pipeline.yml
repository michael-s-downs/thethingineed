### This code is property of the GGAO ###


trigger:
  batch: true
  branches:
    include:
    - develop
    - release/v*
    - master
  paths:
    include:
    - 'services/techhubflowmgmtcheckend/*'
    - 'helm/'

variables:
- group: Variables para CI
- group: Params Python
- group: RegistryVariables

- name: serviceName
  value: 'techhubflowmgmtcheckend'
- name:  projectName
  value: 'TechHubGlobalToolkit'
- name:  vmImageName
  value: 'ubuntu-20.04'
- name:  pythonVersion
  value: '$(python_version)'
- name:  baseImage
  value: '$(default_base)'
- name:  registryServerName
  value: '$(registryName).azurecr.io'
- name: acrRegistryLogin
  value: '$(registryLogin)'
- name: acrRegistryPassword
  value: '$(registryPassword)'
- name: templateType
  value: 'microservicesgenai'
- name: helmRepoLocation
  value: '$(Agent.BuildDirectory)/s/helm'
- name: helmVersion
  value: '$(helmVer)'
- name: projectLocation
  value: '$(Agent.BuildDirectory)/s/services'
- name: description
  value: 'Microservice to flow management. Report final status to process'
- name: feedGenai
  value: '$(feed_genai)'

stages:
- stage: SonarAnalysis
  jobs:
  - job:
    continueOnError: false
    pool:
      vmImage: $(vmImageName)
    steps:
      - task: UsePythonVersion@0
        inputs:
          versionSpec: '3.11'
          addToPath: true
          architecture: 'x64'

      - script: |
            echo install magic 
            sudo apt-get install libmagic1

            python -m venv .venv
            source .venv/bin/activate

            cd $(System.DefaultWorkingDirectory)/imagesbase/$(baseImage)
            echo "installing requirements from $(pwd)"
            pip install -r requirements.txt

            echo "installing requirements from $(pwd)"
            cd $(System.DefaultWorkingDirectory)/libraries/genai_sdk_services

            pip install --upgrade pip
            python -m pip install -U setuptools wheel twine
            python setup.py install

            echo build package 
            python setup.py build_ext --inplace
            python setup.py bdist_wheel --python-tag=cp$(python_version)

            echo $(serviceName)
            cd $(System.DefaultWorkingDirectory)/services/$(serviceName)/

            echo "installing requirements from $(pwd)"
            pip install -r requirements.txt
            pip install pytest pytest-cov 

            export PYTHONPATH=$(System.DefaultWorkingDirectory)/services/
            echo running coverage
            coverage run --source=$(System.DefaultWorkingDirectory)/services/$(serviceName)/ -m pytest -s
            coverage report
            coverage xml
        displayName: Coverage report


      - task: SonarQubePrepare@7
        inputs:
          SonarQube: 'sonarqube_service_connection_techhub_dev_japaneast'
          scannerMode: 'cli'
          configMode: 'manual'
          cliProjectKey: $(System.DefinitionName)
          cliSources: '$(System.DefaultWorkingDirectory)/services/$(serviceName)/'
          extraProperties: |
              sonar.projectVersion=1.0
              sonar.sources=$(System.DefaultWorkingDirectory)/services/$(serviceName)/
              sonar.python.coverage.reportPaths=$(System.DefaultWorkingDirectory)/services/$(serviceName)/coverage.xml
              sonar.exclusions=**/test/**

      # removes sonar.branch.name variable as this is not supported by community edition
      - task: PowerShell@2
        inputs:
          targetType: 'inline'
          script: |
            $params = "$env:SONARQUBE_SCANNER_PARAMS" -replace '"sonar.branch.name":"[\w,/,-]*"\,?'
                Write-Host "##vso[task.setvariable variable=SONARQUBE_SCANNER_PARAMS]$params"      
      - task: SonarQubeAnalyze@7
        inputs:
          jdkversion: 'JAVA_HOME_17_X64'

      - task: SonarQubePublish@7
        inputs:
          pollingTimeoutSec: '300'

- stage: Building
  displayName: Build image
  jobs:
  - job:
    pool:
      vmImage: $(vmImageName)
    steps:
    - template: ../ap-template.yml
      parameters:
        serviceName: '$(serviceName)'
        registryServerName: '$(registryServerName)'
        acrRegistryLogin:  '$(acrRegistryLogin)'
        acrRegistryPassword:  '$(acrRegistryPassword)'
        defaultWorkingDirectory: '$(system.defaultWorkingDirectory)'
        sourcesDirectory: '$(projectLocation)/$(serviceName)'
        tag: '$(Build.BuildNumber)'
        pythonVersion: '$(pythonVersion)'
        baseImage: '$(baseImage)'
        projectLocation: '$(projectLocation)'
        helmRepoLocation: '$(helmRepoLocation)'
        helmVersion: '$(helmVersion)'
        templateType: '$(templateType)'
        description: '$(description)'
        libraryFeed: '$(feedGenai)'