### This code is property of the GGAO ###

# This templating with multiple pipelines and their triggering is needed until we can know what resource initiates/triggers the pipeline
# https://github.com/MicrosoftDocs/azure-devops-docs/issues/3398#issuecomment-596299643

parameters:
- name: serviceName
  type: string

- name: pythonVersion
  default: '3.11'
  type: string

- name: sonarCliProjectKey
  type: string

- name: libraryFeed
  type: string

steps:
# Copy repos
- checkout: self

# Authenticate feed
- task: PipAuthenticate@1
  inputs:
    artifactFeeds: '${{ parameters.libraryFeed }}'
    onlyAddExtraIndex: true
  displayName: Authenticate feed

# Use python to compile
- task: UsePythonVersion@0
  inputs:
    versionSpec: '${{ parameters.pythonVersion }}'
  displayName: Use Python ${{ parameters.pythonVersion }}

- script: |
      python -m venv .venv
      source .venv/bin/activate
      touch pip.conf
      echo "[global]
      index-url=https://pkgs.dev.azure.com/GAOTechHub/TechHub/_packaging/TechHub/TechHub/pypi/simple/"> pip.conf
      echo "pip.conf"
      cat pip.conf
      echo ${{ parameters.serviceName }}
      cd /home/vsts/work/1/s/services/${{ parameters.serviceName }}/

      echo installing packages
      pip install pytest pytest-cov pillow flask
      pip install -r requirements_info.txt
      pip install -r requirements.txt

      export PYTHONPATH=$(System.DefaultWorkingDirectory)/services/
      echo running coverage
      coverage run --source=$(System.DefaultWorkingDirectory)/services/${{ parameters.serviceName }}/ -m pytest -s
      coverage report
      coverage xml 
      cat coverage.xml
  displayName: Install dependencies & Generate coverage report


- task: SonarQubePrepare@7
  inputs:
    SonarQube: 'sonarqube_service_connection_techhub_dev_japaneast'
    scannerMode: 'cli'
    configMode: 'manual'
    cliProjectKey: $(System.DefinitionName)
    cliSources: '$(System.DefaultWorkingDirectory)/services/${{ parameters.serviceName }}/'
    extraProperties: |
        sonar.projectVersion=1.0
        sonar.sources=$(System.DefaultWorkingDirectory)/services/${{ parameters.serviceName }}/
        sonar.python.coverage.reportPaths=$(System.DefaultWorkingDirectory)/services/${{ parameters.serviceName }}/coverage.xml
        sonar.exclusions=**/test/**

# removes sonar.branch.name variable as this is not supported by community edition
- task: PowerShell@2
  inputs:
    targetType: 'inline'
    script: |
      $params = "$env:SONARQUBE_SCANNER_PARAMS" -replace '"sonar.branch.name":"[\w,/,-]*"\,?'
          Write-Host "##vso[task.setvariable variable=SONARQUBE_SCANNER_PARAMS]$params"      
- task: SonarQubeAnalyze@7
  inputs:
    jdkversion: 'JAVA_HOME_17_X64'

- task: SonarQubePublish@7
  inputs:
    pollingTimeoutSec: '300'

